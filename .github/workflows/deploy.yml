name: Deploy to Cloud Run

on:
  push:
    branches: [main]

env:
  PROJECT_ID: luka-websites
  REGION: europe-north1
  SERVICE: meerkat-website
  IMAGE: europe-north1-docker.pkg.dev/luka-websites/cloud-run/meerkat-website

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: access_token

      - uses: docker/login-action@v3
        with:
          registry: europe-north1-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - name: Build and push
        run: |
          docker build -t $IMAGE:${{ github.sha }} -t $IMAGE:latest .
          docker push $IMAGE:${{ github.sha }}
          docker push $IMAGE:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE \
            --image $IMAGE:${{ github.sha }} \
            --region $REGION \
            --project $PROJECT_ID \
            --allow-unauthenticated \
            --port 8080 \
            --quiet
